# Dampier Lab Snakemake Wrappers

A collection of snakemake wrappers that are not suitable for the wider snakemake-wrappers config.


## Usage

The wrappers are designed to be used in the snakemake workflow.
They can be used from the Github repo directly.

```python
rule dorado_duplex:
    input:
        "data/reads.fastq.gz"
    output:
        "data/reads.duplex.fastq.gz"
    wrapper:
        "https://github.com/damlab/damlab-wrappers/blob/main/dorado/duplex"
```

For certain tools, you may need to install the tool environment separately.

```bash
git clone https://github.com/damlab/damlab-wrappers.git
cd damlab-wrappers
make install
```

```python
rule strainline_haplotypes:
    input:
        "data/reads.fastq.gz"
    output:
        "data/haplotypes.fasta"
    params:
        prefix = f"{wrappers_path}/strainline/venv"
    wrapper:
        f"file://{wrappers_path}/strainline/strainline"
```

## Workflows

### Proviral NFL Pipeline

A complete end-to-end pipeline for processing Nanopore sequencing data from POD5 files to aligned BAMs and QC reports. Ideal for viral near-full-length (NFL) sequencing projects.

**Features:**
- Duplex and simplex basecalling with Dorado
- Scatter mode for distributed cluster execution
- Automated demultiplexing
- Reference-based alignment
- Haplotype reconstruction with Strainline
- Deletion block detection for identifying defective proviruses
- Comprehensive QC reporting with MultiQC

**Documentation:** [`workflows/proviral_nfl.md`](workflows/proviral_nfl.md)

**Quick Start:**
```bash
# Create config and samples.csv, then run:
snakemake --snakefile workflows/proviral_nfl.smk --cores 8 --use-conda
```

## Dorado basecalling

This package contains wrappers for the Nanopore dorado tool.

 - [`dorado/duplex`](dorado/duplex/README.md) : Nanopore dorado duplex basecalling tool. Supports GPU acceleration and optional reference-based alignment.
 - [`dorado/simplex`](dorado/simplex/README.md) : Nanopore dorado simplex basecalling tool. Supports GPU acceleration and optional reference-based alignment.
 - [`dorado/demux`](dorado/demux/README.md) : Nanopore dorado demultiplexing tool. Supports various barcoding kits and custom barcode arrangements.
 - [`dorado/aligner`](dorado/aligner/README.md) : Nanopore dorado aligner tool. Supports GPU acceleration and optional reference-based alignment.


## POD5

This package contains wrappers for the POD5 file format.

 - [`pod5/convert_fast5`](pod5/convert_fast5/README.md) : Convert Oxford Nanopore FAST5 files to the newer POD5 format.
 - [`pod5/split_by_channel`](pod5/split_by_channel/README.md) : Split POD5 files by channel.


## Multiple sequence alignment

This package contains wrappers for the multiple sequence alignment tools.

 - [`MSA/muscle`](MSA/muscle/README.md) : MUSCLE multiple sequence alignment tool.

## Strainline

This package contains wrappers for the Strainline reference free haplotype assembly tool.
This package requires the `strainline` tool to be installed via the provided makefile.

 - [`strainline/strainline`](strainline/strainline/README.md) : Strainline haplotype assembly tool.
 - [`strainline/clipqs`](strainline/clipqs/README.md) : ClipQS tool to orient and clip sequences generated by the Strainline tool.

## Seqkit

This package contains wrappers that extend the Seqkit tool.

 - [`seqkit/primercheck`](seqkit/primercheck/README.md) : Seqkit primer checking tool. Given a primer file and a set of reads, it will check if the reads contain the primers and return the amplicon length.

## Cigarmath

This package contains wrappers for the Cigarmath library.

 - [`cigarmath/deletion_frequency`](cigarmath/deletion_frequency/README.md) : Calculate the deletion frequency of a given region.
 - [`cigarmath/deletion_block_detection`](cigarmath/deletion_block_detection/README.md) : Detect large deletion blocks in aligned BAM files, useful for identifying defective proviruses.
 - [`cigarmath/pileup`](cigarmath/pileup/README.md) : Calculate per-position coverage depth.

## Phylogenetic tree construction

This package contains wrappers for the Phylogenetic tree construction tools.

 - [`phylo/FastTree`](phylo/FastTree/README.md) : Fasttree phylogenetic tree construction tool.
 - [`phylo/phytreeviz`](phylo/phytreeviz/README.md) : Phytreeviz tool for visualizing phylogenetic trees.
 - [`phylo/reroot`](phylo/reroot/README.md) : Rerooting tool to reroot a tree using dendropy.

## Barcode and UMI

This package contains wrappers for the barcode and UMI tools.

 - [`barcode/extract`](barcode/extract/README.md) : Extract barcodes and UMIs from a BAM file.
 - [`barcode/correct`](barcode/correct/README.md) : Correct barcodes in a BAM file.

## Huggingface

This package contains wrappers for various AI tools.

 - [`huggingface/hiv-bert`](huggingface/hiv-bert/README.md) : Run HIV-BERT models on provided sequences.

## Visualization

A collection of snakemake wrappers of Python APIs for visualization.

- [`visualization/jaspar2logo`](visualization/jaspar2logo/README.md) : Create sequence logos from frequency counts.

## Miscellaneous

- [`picard/addorreplacereadgroups`](picard/addorreplacereadgroups/README.md) : Picard tool to add or replace read groups in a BAM file. Slightly modified to have an easier way to set parameters.

## Testing

Use `make test` to check all tests.

